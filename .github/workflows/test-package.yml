# Crudely test the phaseshifts package, checking:
#
#   1. Dependencies install
#   2. Package builds (notably compiling libphsh.f using f2py)
#   3. Run python software tests

# This workflow will install Python dependencies, run tests and lint with a variety of Python versions
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python

name: Test Package

on:
  push:
    branches: ["master"]
    paths:
      - phaseshifts/**
      - tests/**
      - setup.py
      - requirements*.txt
      - Makefile
      - MANIFEST.in
      - "**/*.py"
      - "**/*.f"
      - CMakeLists.txt
      - pyproject.toml
  pull_request:
    branches: ["master"]
    paths:
      - phaseshifts/**
      - tests/**
      - setup.py
      - requirements*.txt
      - Makefile
      - MANIFEST.in
      - "**/*.py"
      - "**/*.f"
      - CMakeLists.txt
      - pyproject.toml

jobs:
  build:
    env:
      PHASESHIFTS_COMPILE_MISSING: "0"
      PHASESHIFTS_SKIP_COMPILE_ON_IMPORT: "1"
      PYTHONPATH: ${{ github.workspace }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - windows-latest # TODO: Needs #32 to be resolved
          # - macos-latest
        python-version:
          # NOTE: 2.7 through to 3.7 inclusive are not provided in the ubuntu-latest runner
          # - "3.8"  # This version has issues with the build, but is not officially supported anyway
          - "3.9"
          - "3.10"
          - "3.11"
          - "3.12"
          - "3.13"
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      # Setup Fortran compiler - works on all platforms
      - name: Setup Fortran compiler
        uses: fortran-lang/setup-fortran@v1
        id: setup-fortran
        with:
          compiler: gcc
          version: 13

      - name: Display Fortran compiler info
        run: |
          echo "Fortran compiler: ${{ env.FC }}"
          ${{ env.FC }} --version
          echo "C compiler: ${{ env.CC }}"
          ${{ env.CC }} --version

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install flake8 pytest pytest-cov
          pip install -r requirements.txt
          pip install numpy

      - name: Install build dependencies
        run: |
          # Install scikit-build-core for modern builds
          pip install "scikit-build>=0.17" "scikit-build-core>=0.5" cmake ninja
        shell: bash

      # Unix build (Linux/macOS)
      - name: Build package (Unix)
        if: runner.os != 'Windows'
        run: |
          echo "Building on Unix with FC=${{ env.FC }}"
          cd phaseshifts/lib
          python -m phaseshifts.lib._f2py_shim libphsh.f -m libphsh -c --f77flags="-frecursive -fcheck=bounds -std=legacy"
          ls -l libphsh*
        env:
          PYTHON: python
          FC: ${{ env.FC }}
          CC: ${{ env.CC }}
          PYTHONPATH: ${{ github.workspace }}

      # Windows build - use f2py directly with the Fortran compiler from setup-fortran
      - name: Build package (Windows)
        if: runner.os == 'Windows'
        run: |
          echo "Building on Windows with gfortran"
          echo "FC=${{ env.FC }}"
          echo "CC=${{ env.CC }}"

          # Navigate to lib directory and build
          cd phaseshifts/lib

          # Verify source file exists
          if (!(Test-Path "libphsh.f")) {
            Write-Error "libphsh.f not found!"
            exit 1
          }

          # Build using f2py with explicit Fortran flags and distutils shim
          python -m phaseshifts.lib._f2py_shim libphsh.f -m libphsh -c --f77flags="-frecursive -fcheck=bounds -std=legacy"

          # Verify build output
          Get-ChildItem libphsh*
        shell: pwsh
        env:
          FC: ${{ env.FC }}
          CC: ${{ env.CC }}
          PYTHONPATH: ${{ github.workspace }}

      - name: Verify build
        run: |
          python -c "import phaseshifts.lib.libphsh as phsh; print('libphsh imported successfully!')"
        shell: bash
        env:
          PYTHONPATH: ${{ github.workspace }}
      - name: Lint with flake8
        continue-on-error: true
        run: |
          # stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      - name: Install package with test extras
        run: |
          pip install '.[test]'

      - name: Test with pytest
        run: |
          pytest tests/ -v --cov=phaseshifts --cov-report=xml
        env:
          PHASESHIFTS_TEST_USE_SOURCE: "1"

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: coverage.xml
          fail_ci_if_error: false

      - name: Run codacy-coverage-reporter
        if: always()
        continue-on-error: true
        uses: codacy/codacy-coverage-reporter-action@v1
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
          coverage-reports: coverage.xml
