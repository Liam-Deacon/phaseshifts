name: Build Pyodide Wheels

on:
  workflow_dispatch:
  pull_request:
    branches: ['master']
    paths:
      - '.github/workflows/build-pyodide-wheel.yml'
      - 'phaseshifts/**'
      - 'setup.py'
      - 'pyproject.toml'
      - 'phaseshifts_build_backend.py'
      - 'wasm/**'

jobs:
  build_pyodide:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@6ab9eb1bda2574c4ddb79809fc9247783eaf9021
        with:
          version: 'latest'
          actions-cache-folder: 'emsdk-cache'

      - name: Install f2c
        run: |
          sudo apt-get update
          sudo apt-get install -y f2c libf2c2-dev

      - name: Build WASM artifacts (f2c)
        run: |
          cd wasm
          ./build.sh --method=f2c
        continue-on-error: true

      - name: Stage WASM assets for wheel
        run: |
          mkdir -p phaseshifts/wasm/dist
          if [ -d "wasm/dist" ] && [ "$(ls -A wasm/dist 2>/dev/null)" ]; then
            cp -r wasm/dist/* phaseshifts/wasm/dist/
          else
            echo "::warning::WASM dist directory is empty; wheel will ship without artifacts."
          fi

      - name: Build pyodide wheels
        uses: pypa/cibuildwheel@63fd63b352a9a8bdcc24791c9dbee952ee9a8abc
        env:
          CIBW_PLATFORM: pyodide
          # NOTE: cp314-pyodide_wasm32 is tracked in issue #155 once Pyodide ships 3.14 wheels.
          CIBW_BUILD: cp312-pyodide_wasm32 cp313-pyodide_wasm32
          CIBW_TEST_COMMAND: python -c "import phaseshifts; print(phaseshifts.__version__)"
          PHASESHIFTS_DISABLE_SKBUILD: '1'
          PHASESHIFTS_SKIP_FORTRAN: '1'
          PHASESHIFTS_INCLUDE_WASM_ASSETS: '1'

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: pyodide-wheels
          path: dist/

      - name: Upload wasm artifacts
        if: ${{ hashFiles('wasm/dist/*') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: wasm-f2c-artifacts
          path: wasm/dist
