name: GitHub Pages

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.11'

      - name: Upgrade pip
        run: |
          # install pip=>20.1 to use "pip cache dir"
          python3 -m pip install --upgrade pip

      - name: Get pip cache dir
        id: pip-cache
        run: echo "dir=$(pip cache dir)" >> $GITHUB_OUTPUT

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ${{ steps.pip-cache.outputs.dir }}
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install numpy setuptools wheel  # NOTE: needed for non PEP-517 enabled projects
          python3 -m pip install -e .[docs] || python3 -m pip install -r requirements-doc.txt
        env:
          PHASESHIFTS_COMPILE: 'false'
      - name: Build HTML Docs
        run: | # NOTE: .nojekyll is important to maintain sphinx rendering
          make html && touch _build/html/.nojekyll
        working-directory: docs

      - name: Prepare combined site
        run: |
          mkdir -p _site

          # Copy Sphinx docs to root
          if [ -d "docs/_build/html" ]; then
            cp -r docs/_build/html/* _site/
          else
            echo "::error::Sphinx build failed - no HTML output"
            exit 1
          fi

          # Disable Jekyll processing
          touch _site/.nojekyll

          # Create calculator directory structure
          mkdir -p _site/calculator/dist
          mkdir -p _site/calculator/shared

          # Copy WASM calculator web files (excluding symlinks that may not be ready)
          for file in wasm/web/*; do
            if [ ! -L "$file" ]; then  # Skip symlinks
              cp -r "$file" _site/calculator/
            fi
          done

          # Copy API file if exists
          cp wasm/src/phaseshifts.js _site/calculator/ 2>/dev/null || true

          # Copy shared modules/styles to calculator/shared (fixes relative import paths)
          cp wasm/shared/*.js _site/calculator/shared/ 2>/dev/null || true
          cp wasm/shared/*.css _site/calculator/shared/ 2>/dev/null || true

          # Copy WASM dist files if available (for symlink resolution)
          if [ -d "wasm/dist" ] && [ ! -L "wasm/dist" ]; then
            cp -r wasm/dist/* _site/calculator/dist/ 2>/dev/null || true
          fi

          # Copy built WASM if available, otherwise create demo mode placeholder
          if [ -f "wasm/dist/phaseshifts.js" ] && [ -f "wasm/dist/phaseshifts.wasm" ]; then
            cp -r wasm/dist/* _site/calculator/dist/
            echo "full" > _site/calculator/dist/mode.txt
          else
            # Create demo mode placeholder
            cat > _site/calculator/dist/phaseshifts.js << 'EOF'
          // Demo mode - WASM module not built
          // The app.js will generate synthetic phase shifts for demonstration
          console.log('[phaseshifts] Running in demo mode - WASM module not available');
          window.WASM_DEMO_MODE = true;
          EOF
            echo "demo" > _site/calculator/dist/mode.txt
          fi

          # Create version info
          cat > _site/calculator/version.txt << EOF
          phaseshifts WASM Calculator
          Built: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Commit: ${{ github.sha }}
          Mode: $(cat _site/calculator/dist/mode.txt)
          EOF

      - name: Upload HTML site artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
